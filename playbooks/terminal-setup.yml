---
- name: Configure Linux system with Zsh, Oh My Zsh, Powerlevel10k, and custom aliases/functions
  hosts: all
  remote_user: intergalactic
  tasks:

    - name: Install required tools
      package:
        name:
          - git
          - curl
          - zsh
          - fzf
          - wget
          - neofetch
          - btop
        state: present
      become: true

    - name: Clean up existing Zsh configurations
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ ansible_env.HOME }}/.oh-my-zsh"
        - "{{ ansible_env.HOME }}/.zsh"
      become: false

    - name: Clean up existing Powerlevel10k configuration
      file:
        path: "{{ ansible_env.HOME }}/.p10k.zsh"
        state: absent
      become: false

    - name: Create Zsh custom directory
      file:
        path: "{{ ansible_env.HOME }}/.zsh"
        state: directory
      become: false

    - name: Preserve shell history
      file:
        path: "{{ ansible_env.HOME }}/.tmp_history"
        state: directory
      become: false

    - name: Backup .bash_history if it exists
      command: mv {{ ansible_env.HOME }}/.bash_history {{ ansible_env.HOME }}/.tmp_history/bash_history
      when: ansible_facts['ansible_env']['HOME'] is defined and lookup('file', ansible_env.HOME + '/.bash_history') is not none
      become: false

    - name: Backup .zsh_history if it exists
      command: mv {{ ansible_env.HOME }}/.zsh_history {{ ansible_env.HOME }}/.tmp_history/zsh_history
      when: ansible_facts['ansible_env']['HOME'] is defined and lookup('file', ansible_env.HOME + '/.zsh_history') is not none
      become: false

    - name: Install Oh My Zsh
      shell: |
        sh -c "$(curl -fsSL https://josiasleal:{{ github_token_classic }}@raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
      args:
        creates: "{{ ansible_env.HOME }}/.oh-my-zsh"
      become: false

    - name: Check if Powerlevel10k theme exists
      stat:
        path: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes/powerlevel10k"
      register: powerlevel10k_stat
      become: false

    - name: Install Powerlevel10k theme
      git:
        repo: https://github.com/romkatv/powerlevel10k.git
        dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes/powerlevel10k"
      when: not powerlevel10k_stat.stat.exists
      become: false

    - name: Check if Zsh plugins exist
      stat:
        path: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/{{ item }}"
      register: plugin_stat
      loop:
        - zsh-autosuggestions
        - zsh-completions
        - zsh-syntax-highlighting
        
      become: false

    - name: Install Zsh plugins
      git:
        repo: "https://github.com/zsh-users/{{ item }}.git"
        dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/{{ item }}"
        clone: yes
      loop: "{{ plugin_stat.results | selectattr('stat.exists', 'equalto', false) | map(attribute='item') | list }}"
      become: false

    - name: Check if custom Zsh files exist
      stat:
        path: "{{ item.dest }}"
      register: custom_zsh_files
      loop:
        - { url: "https://josiasleal:{{ github_token_classic }}@raw.githubusercontent.com/josiasleal/dotfiles/refs/heads/master/.zsh_homelab/.p10k.zsh", dest: "{{ ansible_env.HOME }}/.p10k.zsh" }
        - { url: "https://josiasleal:{{ github_token_classic }}@raw.githubusercontent.com/josiasleal/dotfiles/refs/heads/master/.zsh_homelab/aliases.zsh", dest: "{{ ansible_env.HOME }}/.zsh/aliases.zsh" }
        - { url: "https://josiasleal:{{ github_token_classic }}@raw.githubusercontent.com/josiasleal/dotfiles/refs/heads/master/.zsh_homelab/functions.zsh", dest: "{{ ansible_env.HOME }}/.zsh/functions.zsh" }
      become: false

    - name: Download .p10k.zsh, aliases.zsh, and functions.zsh
      get_url:
        url: "{{ item.url }}"
        dest: "{{ item.dest }}"
      loop: "{{ custom_zsh_files.results | selectattr('stat.exists', 'equalto', false) | map(attribute='item') | list }}"
      become: false

    - name: Configure .zshrc
      copy:
        dest: "{{ ansible_env.HOME }}/.zshrc"
        content: |
          # Oh-My-Zsh configuration
          export ZSH="{{ ansible_env.HOME }}/.oh-my-zsh"
          ZSH_THEME="powerlevel10k/powerlevel10k"
          plugins=(zsh-autosuggestions zsh-completions zsh-syntax-highlighting)
          source "$ZSH/oh-my-zsh.sh"
          source "{{ ansible_env.HOME }}/.zsh/aliases.zsh"
          source "{{ ansible_env.HOME }}/.zsh/functions.zsh"
          [[ ! -f "$HOME/.p10k.zsh" ]] || source "$HOME/.p10k.zsh"
      become: false

    - name: Change default shell to Zsh
      shell: chsh -s $(which zsh) "{{ ansible_user }}"
      when: ansible_facts.shell != "/usr/bin/zsh"
      become: false

    - name: Append preserved history to new history files
      block:
        - name: Append bash history to zsh history
          shell: cat {{ ansible_env.HOME }}/.tmp_history/bash_history >> {{ ansible_env.HOME }}/.zsh_history
          when: ansible_facts['ansible_env']['HOME'] is defined and lookup('file', ansible_env.HOME + '/.tmp_history/bash_history') is not none
        - name: Append zsh history to zsh history
          shell: cat {{ ansible_env.HOME }}/.tmp_history/zsh_history >> {{ ansible_env.HOME }}/.zsh_history
          when: ansible_facts['ansible_env']['HOME'] is defined and lookup('file', ansible_env.HOME + '/.tmp_history/zsh_history') is not none
      become: false
